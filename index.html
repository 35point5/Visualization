<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <title>全国空气质量</title>
    <style>
        #title{
            position: absolute;
            top:0vh;
            left:0vw;
            width: 100vw;
            height: 20vh;
        }
        #container {
            position: absolute;
            top: 20vh;
            left: 50vw;
            width: 47.5vw;
            height: 77.5vh;
        }
        #Detail{
            position: absolute;
            top: 20vh;
            left: 1vw;
            width: 50vw;
            height: 30vh;
        }
        #Charts_Div{
            position: absolute;
            top: 50vh;
            left: 0vw;
            width: 50vw;
            height: 47.5vh;
        }
        .text{
            width: 10%;
        }
    </style>
    <div id="title">
        <h1 style="text-align: center;">全国大气污染可视化</h1> <!-- 标题 -->
        <hr>
        <h3 style="text-align: right;">——基于2013年至2016年大气污染数据</h3>   
    </div> 
</head>

<body style="background-color:rgb(231, 233, 240);" onload="init()">
     
    <div id="Detail">
        <div style="width: 15vw; height: 30vh;" id="Rader"></div>
    </div>
    <div id="container" class="container">
        <div style="position:absolute; z-index:999; top:0;">
            <p style="color: rgb(11, 18, 119);" title="I'm a tooltip">请依次输入年、月、日:</p> 
            <input id="YearInput" value="2013"  onchange="ListenDate()" class="text">
            <input id="MonthInput" value="1" onchange="ListenDate()" class="text">
            <input id="DayInput" value="1"  onchange="ListenDate()" class="text">
            <input id="up-btn" type="button" class="button" value="返回" />
        </div>
    </div>
    <div id="Charts_Div">
        <div id="Charts" style="height: 35vh;"></div>
        <div id="Bars" style="height: 12.5vh;"></div>
    </div>
    <script src="https://a.amap.com/Loca/static/dist/jquery.min.js"></script>
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=a1f20e56788bc5e9930326306872d63e"></script>
    <script src="https://webapi.amap.com/loca?v=1.3.2&key=a1f20e56788bc5e9930326306872d63e"></script>
    <script src="https://a.amap.com/Loca/static/mock/districts.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
            var province_now='北京市';
            var data;
            var httpRequest=new XMLHttpRequest();
            var map = new AMap.Map('container', {
                //mapStyle: 'amap://styles/db9efe6a1745ac24b7269b862f359536',
                viewMode: '2D',
                pitch: 0,
                features: ['bg', 'road'],
                zoom: 3.8,
                center: [107.4976, 32.1697]
            });
            

            var layer = new Loca.DistrictLayer({
                eventSupport: true,
                map: map,
                fitView: true,
                drillDown: false,
            });
            
            
            layer.setOptions({
                mode: 'mean',
                style: {
                    color: ['#0c2c84', '#225ea8', '#225ea8', '#41b6c4', '#7fcdbb', '#c7e9b4', '#ffffcc'],
                    height: [0, 300000],
                    opacity: 0.86
                }
            });
            
            var infoWin;

            infoWin = new AMap.InfoWindow({
                closeWhenClickMap: true
            });
            layer.on('mouseover', function(event) {
                var pos=event.feature.subFeature.properties.center;
                var lnglat = new AMap.LngLat(pos[0], pos[1]);
                infoWin.setContent(event.feature.subFeature.properties.name);
                infoWin.open(map, lnglat);
                console.log(pos);
            });
            layer.on('click', function(event) {
                var day=document.getElementById("DayInput").value;
                var month=document.getElementById("MonthInput").value;
                var year=document.getElementById("YearInput").value;
                layer.goto(event.feature.subFeature.properties.adcode);
                var province=event.feature.subFeature.properties.name;
                province_now=province;
                draw_charts(province);
                Draw_Rader(province,year,month,day);
                Draw_Bars(province);
            });
            function ListenDate(){
                var day=document.getElementById("DayInput").value;
                var month=document.getElementById("MonthInput").value;
                var year=document.getElementById("YearInput").value;
                Draw_Rader(province_now,year,month,day);
                $.get("https://raw.githubusercontent.com/35point5/Visualization/main/res/"+year+"_"+month+"_"+day+".csv",(data)=>{
                    layer.setData(data, {
                        type: 'csv',
                        lnglat: 'lon',
                        value: 'IAQI'
                    });
                    layer.render();
                })
            }
            $('#up-btn').click(function () {
                layer.goto(-1);
            });
    </script>
    <script>
        var dom_charts = document.getElementById("Charts");
        var myChart = echarts.init(dom_charts);
        var app = {};

        var option;

        function draw_charts(province){
            $.get('https://raw.githubusercontent.com/35point5/Visualization/main/date/'+province+'.json', function (datastr,status) {
                if (status!="success") return;
                var data=JSON.parse(datastr);
                console.log(data);
                console.log(data["0"]["date"]);
                DataX=new Array();
                var len=0;
                for(var i in data){
                    DataX[len++]=data[i+'']['date'];
                }

                DataY=new Array();
                len=0;
                for(var i in data){
                    DataY[len++]=data[i+'']['IAQI'];
                }

                DataSO2=new Array();
                len=0;
                for(var i in data){
                    DataSO2[len++]=data[i+'']['IAQI_SO2'];
                }

                DataNO2=new Array();
                len=0;
                for(var i in data){
                    DataNO2[len++]=data[i+'']['IAQI_NO2'];
                }

                DataPM25=new Array();
                len=0;
                for(var i in data){
                    DataPM25[len++]=data[i+'']['IAQI_PM25'];
                }

                DataPM10=new Array();
                len=0;
                for(var i in data){
                    DataPM10[len++]=data[i+'']['IAQI_PM10'];
                }
                myChart.setOption(option = {
                    legend: {
                        data: [province+' AQI','IAQI_SO2','IAQI_NO2','IAQI_PM25','IAQI_PM10']
                    },
                    title: {
                        text: province+' AQI',
                        left: '1%'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '5%',
                        right: '15%',
                        bottom: '10%'
                    },
                    xAxis: {
                        // data: data.map(function (item) {
                        //     return item[0];
                        // })
                        data: DataX
                    },
                    yAxis: {},
                    toolbox: {
                        right: 10,
                        feature: {
                            dataZoom: {
                                yAxisIndex: 'none'
                            },
                            restore: {},
                            saveAsImage: {}
                        }
                    },
                    dataZoom: [{
                        startValue: '2013-01-01'
                    }, {
                        type: 'inside'
                    }],
                    visualMap: {
                        top: 50,
                        right: 10,
                        pieces: [{
                            gt: 0,
                            lte: 50,
                            color: '#93CE07'
                        }, {
                            gt: 50,
                            lte: 100,
                            color: '#FBDB0F'
                        }, {
                            gt: 100,
                            lte: 150,
                            color: '#FC7D02'
                        }, {
                            gt: 150,
                            lte: 200,
                            color: '#FD0100'
                        }, {
                            gt: 200,
                            lte: 300,
                            color: '#AA069F'
                        }, {
                            gt: 300,
                            color: '#AC3B2A'
                        }],
                        outOfRange: {
                            color: '#999'
                        }
                    },
                    series: [{
                        name: province+' AQI',
                        type: 'line',
                        data: DataY,
                        symbol: 'circle',
                        markLine: {
                            silent: true,
                            lineStyle: {
                                color: '#333'
                            },
                            data: [{
                                yAxis: 50
                            }, {
                                yAxis: 100
                            }, {
                                yAxis: 150
                            }, {
                                yAxis: 200
                            }, {
                                yAxis: 300
                            }]
                        }
                    },
                    {
                        name: 'IAQI_SO2',
                        type: 'line',
                        data: DataSO2,
                        symbol: 'triangle'
                    },
                    {
                        name: 'IAQI_NO2',
                        type: 'line',
                        data: DataNO2,
                        symbol: 'rect'
                    },
                    {
                        name: 'IAQI_PM25',
                        type: 'line',
                        data: DataPM25,
                        symbol: 'roundRect'
                    },
                    {
                        name: 'IAQI_PM10',
                        type: 'line',
                        data: DataPM10,
                        symbol: 'diamond'
                    }]
                });
            });

            if (option && typeof option === 'object') {
                myChart.setOption(option);
            }
        }
    </script>
    <script>
        var dom_bars = document.getElementById("Bars");
        var Bars = echarts.init(dom_bars);
        var app = {};

        var option_Bars;
        function Draw_Bars(province){
            $.get('https://raw.githubusercontent.com/35point5/Visualization/main/date/'+province+'.json', function (datastr,status) {
                p=JSON.parse(datastr);
                var data=new Array();
                for(var i=0;i<6;++i) data[i]=new Array();
                var len=0;
                var last='01';
                for(var i in p){
                    str=p[i+'']['date'].split('-');
                    for(var j=0;j<6;++j) data[j][len]=0;
                    if (last!=str[1]){
                        ++len; last=str[1];
                    }
                }
                console.log(len);
                len=0;
                last='01';
                var X=new Array();
                X.push('2013-01');
                for(var i in p){
                    str=p[i+'']['date'].split('-');
                    if (p[i+'']['IAQI']<=50) ++data[0][len];
                    else if (p[i+'']['IAQI']<=100) ++data[1][len];
                    else if (p[i+'']['IAQI']<=150) ++data[2][len];
                    else if (p[i+'']['IAQI']<=200) ++data[3][len];
                    else if (p[i+'']['IAQI']<=300) ++data[4][len];
                    else ++data[5][len];
                    if (last!=str[1]){
                        X.push(str[0]+'-'+str[1]);
                        ++len; last=str[1];
                    }
                }
                console.log('data:');
                console.log(data);
                console.log(len);
                option_Bars = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                            type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        }
                    },
                    grid: {
                        left: '3%',
                        right: '3%',
                        bottom: '0',
                        top:'0',
                        containLabel: false
                    },
                    xAxis: [
                        {
                            type: 'category',
                            data: X
                        }
                    ],
                    yAxis: [
                        {
                            type: 'value',
                            show: false
                        }
                    ],
                    series: [
                        {
                            name: '优',
                            type: 'bar',
                            stack: 's',
                            emphasis: {
                                focus: 'series'
                            },
                            data: data[0],
                            itemStyle:{
                                normal:{
                                    color:'#93CE07'
                                }
                            },
                        },
                        {
                            name: '良',
                            type: 'bar',
                            stack: 's',
                            emphasis: {
                                focus: 'series'
                            },
                            data: data[1],
                            itemStyle:{
                                normal:{
                                    color:'#FBDB0F'
                                }
                            },
                        },
                        {
                            name: '轻度污染',
                            type: 'bar',
                            stack: 's',
                            emphasis: {
                                focus: 'series'
                            },
                            data: data[2],
                            itemStyle:{
                                normal:{
                                    color:'#FC7D02'
                                }
                            },
                        }
                        ,
                        {
                            name: '中度污染',
                            type: 'bar',
                            stack: 's',
                            emphasis: {
                                focus: 'series'
                            },
                            data: data[3],
                            itemStyle:{
                                normal:{
                                    color:'#FD0100'
                                }
                            },
                        }
                        ,
                        {
                            name: '重度污染',
                            type: 'bar',
                            stack: 's',
                            emphasis: {
                                focus: 'series'
                            },
                            data: data[4],
                            itemStyle:{
                                normal:{
                                    color:'#AA069F'
                                }
                            },
                        }
                        ,
                        {
                            name: '严重污染',
                            type: 'bar',
                            stack: 's',
                            emphasis: {
                                focus: 'series'
                            },
                            data: data[5],
                            itemStyle:{
                                normal:{
                                    color:'#AC3B2A'
                                }
                            },
                        }
                    ]
                };

                if (option_Bars && typeof option_Bars === 'object') {
                    Bars.setOption(option_Bars);
                }
            })
        }
    </script>
    <script>
        function cl(val){
            if (val<10) return '0'+val;
            else return val+'';
        }
        function Draw_Rader(province,year,month,day){
            var dom = document.getElementById("Rader");
            var myChart = echarts.init(dom);
            var app = {};

            var option;

            var lineStyle = {
                normal: {
                    width: 1,
                    opacity: 1
                }
            };
            $.get('https://raw.githubusercontent.com/35point5/Visualization/main/date/'+province+'.json', function (datastr,status){
                if (status!='success') return;
                var p=JSON.parse(datastr);
                var R_data=new Array();
                for(var i=0;i<6;++i) R_data[i]=new Array();
                for(var i in p){
                    if (p[i+'']['date']==year+'-'+cl(month)+'-'+cl(day)){
                    R_data[0][0]=p[i+'']['IAQI_O3'];
                    R_data[0][1]=p[i+'']['IAQI_PM25'];
                    R_data[0][2]=p[i+'']['IAQI_PM10'];
                    R_data[0][3]=p[i+'']['IAQI_CO'];
                    R_data[0][4]=p[i+'']['IAQI_NO2'];
                    R_data[0][5]=p[i+'']['IAQI_SO2'];
                }} 

                option = {
                    //backgroundColor: '#161627',
                    title: {
                        text: '',
                        left: 'center',
                        textStyle: {
                            color: '#eee'
                        }
                    },
                    radar: {
                        indicator: [
                            {name: 'O3', max: 400},
                            {name: 'PM2.5', max: 400},
                            {name: 'PM10', max: 400},
                            {name: 'CO', max: 400},
                            {name: 'NO2', max: 400},
                            {name: 'SO2', max: 400}
                        ],
                        shape: 'polygon',
                        splitNumber: 5,
                        name: {
                            textStyle: {
                                color: '#996600',
                                fontSize: 14,
                            }
                        },
                        splitLine: {
                            lineStyle: {
                                color: [
                                    'rgba(238, 197, 102, 0.1)', 'rgba(238, 197, 102, 0.2)',
                                    'rgba(238, 197, 102, 0.4)', 'rgba(238, 197, 102, 0.6)',
                                    'rgba(238, 197, 102, 0.8)', 'rgba(238, 197, 102, 1)'
                                ].reverse()
                            }
                        },
                        splitArea: {
                            show: false
                        },
                        axisLine: {
                            lineStyle: {
                                color: 'rgba(238, 197, 102, 0.5)'
                            }
                        }
                    },
                    series:{
                            name: '',
                            type: 'radar',
                            lineStyle: lineStyle,
                            data: R_data,
                            symbol: 'none',
                            itemStyle: {
                                color: '#F9713C'
                            },
                            areaStyle: {
                                opacity: 0.1
                            }
                        }
                };

                if (option && typeof option === 'object') {
                    myChart.setOption(option);
                }
            })
        }
    </script>
    <script>
        function init(){
            draw_charts(province_now);
            ListenDate();
            console.log('init');
            Draw_Bars(province_now);
        }
        init();
    </script>
</body>

</html>