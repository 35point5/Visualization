<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <title>全国空气质量</title>
    <style>
        #title{
            position: absolute;
            top:0vh;
            left:0vw;
            width: 100vw;
            height: 20vh;
        }
        #container {
            position: absolute;
            top: 20vh;
            left: 50vw;
            width: 47.5vw;
            height: 77.5vh;
        }
        #Input{
            position: absolute;
            top: 20vh;
            left: 1vw;
            width: 50vw;
            height: 10vh;
        }
        #Charts{
            position: absolute;
            top: 50vh;
            left: 0vw;
            width: 50vw;
            height: 40vh;
        }
        .text{
            width: 10%;
        }
    </style>
    <div id="title">
        <h1 style="text-align: center;">全国大气污染可视化</h1> <!-- 标题 -->
        <hr>
        <h3 style="text-align: right;">——基于2013年至2016年大气污染数据</h3>   
    </div> 
</head>

<body style="background-color:rgb(231, 233, 240);" onload="init()">
     
    <div id="Input">
        
    </div>
    <div id="container" class="container">
        <div style="position:absolute; z-index:999; top:0;">
            <p style="color: rgb(11, 18, 119);" title="I'm a tooltip">请依次输入年、月、日:</p> 
            <input id="YearInput" value="2013"  onchange="ListenDate()" class="text">
            <input id="MonthInput" value="1" onchange="ListenDate()" class="text">
            <input id="DayInput" value="1"  onchange="ListenDate()" class="text">
            <input id="up-btn" type="button" class="button" value="返回" />
        </div>
    </div>
    <div id="Charts"></div>
    <script src="https://a.amap.com/Loca/static/dist/jquery.min.js"></script>
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=a1f20e56788bc5e9930326306872d63e"></script>
    <script src="https://webapi.amap.com/loca?v=1.3.2&key=a1f20e56788bc5e9930326306872d63e"></script>
    <script src="https://a.amap.com/Loca/static/mock/districts.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
            function init(){
                draw_charts('北京市');
                ListenDate();
            }
            var data;
            var httpRequest=new XMLHttpRequest();
            var map = new AMap.Map('container', {
                //mapStyle: 'amap://styles/db9efe6a1745ac24b7269b862f359536',
                viewMode: '2D',
                pitch: 0,
                features: ['bg', 'road'],
                zoom: 3.8,
                center: [107.4976, 32.1697]
            });

            // var layer_temp = new Loca.PointLayer({
            //     eventSupport: true,
            //     map: map,
                
            // });

            // layer_temp.setData(districts, {
            //     // 指定经纬度所在字段
            //     lnglat: 'center'
            // });

            // layer_temp.setOptions({
            //     style: {
            //         // 圆形半径，单位像素
            //         radius: 5,
            //         // 填充颜色
            //         color: '#07E8E4',
            //         // 描边颜色
            //         borderColor: '#5DFBF9',
            //         // 描边宽度，单位像素
            //         borderWidth: 0,
            //         // 透明度 [0-1]
            //         opacity: 0.9,
            //     }
            // });
            // layer_temp.setzIndex(999);
            // layer_temp.render();

            

            var layer = new Loca.DistrictLayer({
                eventSupport: true,
                map: map,
                fitView: true,
                drillDown: false,
            });
            
            
            layer.setOptions({
                mode: 'mean',
                style: {
                    color: ['#0c2c84', '#225ea8', '#225ea8', '#41b6c4', '#7fcdbb', '#c7e9b4', '#ffffcc'],
                    height: [0, 300000],
                    opacity: 0.86
                }
            });
            
            var infoWin;

            infoWin = new AMap.InfoWindow({
                closeWhenClickMap: true
            });
            layer.on('mouseover', function(event) {
                console.log('Raw data: ', event); // 触发元素对应的原始数据
                var pos=event.feature.subFeature.properties.center;
                var lnglat = new AMap.LngLat(pos[0], pos[1]);
                infoWin.setContent(event.feature.subFeature.properties.name);
                infoWin.open(map, lnglat);
                console.log(pos);
            });
            layer.on('click', function(event) {
                layer.goto(event.feature.subFeature.properties.adcode);
                draw_charts(event.feature.subFeature.properties.name);
            });
            // httpRequest.onreadystatechange = function () {
            //     if (httpRequest.readyState == 4 && httpRequest.status == 200) {
            //         //console.log(httpRequest.responseText)
            //         //var json = JSON.parse(httpRequest.responseText);//获取到json字符串，还需解析
            //         //data=json
            //         data=httpRequest.responseText;
            //         //console.log(data)
                
            //         layer.setData(data, {
            //             type: 'csv',
            //             lnglat: 'lon',
            //             value: 'IAQI'
            //         });
            //         layer.render();
            //     }
            // };
            // function ListenDate(){
            //     console.log(233)
            //     //layer.setMap(null)
                
            //     var day=document.getElementById("DayInput").value;
            //     var month=document.getElementById("MonthInput").value;
            //     var year=document.getElementById("YearInput").value;
            //     //httpRequest.open("get","./res/"+year+"_"+month+"_"+day+".csv");
            //     httpRequest.open("get","https://raw.githubusercontent.com/35point5/Visualization/main/res/2014_3_4.csv");
            //     httpRequest.send();
            // }
            function ListenDate(){
                var day=document.getElementById("DayInput").value;
                var month=document.getElementById("MonthInput").value;
                var year=document.getElementById("YearInput").value;
                $.get("https://raw.githubusercontent.com/35point5/Visualization/main/res/"+year+"_"+month+"_"+day+".csv",(data)=>{
                    layer.setData(data, {
                        type: 'csv',
                        lnglat: 'lon',
                        value: 'IAQI'
                    });
                    layer.render();
                })
            }
            $('#up-btn').click(function () {
                layer.goto(-1);
            });
    </script>
    <script>
        var dom = document.getElementById("Charts");
        var myChart = echarts.init(dom);
        var app = {};

        var option;

        function draw_charts(province){
            console.log(province);
            $.get('https://raw.githubusercontent.com/35point5/Visualization/main/date/'+province+'.json', function (datastr,status) {
                console.log(status)
                if (status!="success") return;
                var data=JSON.parse(datastr);
                console.log(data);
                console.log(data["0"]["date"]);
                DataX=new Array();
                var len=0;
                for(var i in data){
                    DataX[len++]=data[i+'']['date'];
                }

                DataY=new Array();
                len=0;
                for(var i in data){
                    DataY[len++]=data[i+'']['IAQI'];
                }

                DataSO2=new Array();
                len=0;
                for(var i in data){
                    DataSO2[len++]=data[i+'']['IAQI_SO2'];
                }

                DataNO2=new Array();
                len=0;
                for(var i in data){
                    DataNO2[len++]=data[i+'']['IAQI_NO2'];
                }

                DataPM25=new Array();
                len=0;
                for(var i in data){
                    DataPM25[len++]=data[i+'']['IAQI_PM25'];
                }

                DataPM10=new Array();
                len=0;
                for(var i in data){
                    DataPM10[len++]=data[i+'']['IAQI_PM10'];
                }
                myChart.setOption(option = {
                    legend: {
                        data: [province+' AQI','IAQI_SO2','IAQI_NO2','IAQI_PM25','IAQI_PM10']
                    },
                    title: {
                        text: province+' AQI',
                        left: '1%'
                    },
                    tooltip: {
                        trigger: 'axis'
                    },
                    grid: {
                        left: '5%',
                        right: '15%',
                        bottom: '10%'
                    },
                    xAxis: {
                        // data: data.map(function (item) {
                        //     return item[0];
                        // })
                        data: DataX
                    },
                    yAxis: {},
                    toolbox: {
                        right: 10,
                        feature: {
                            dataZoom: {
                                yAxisIndex: 'none'
                            },
                            restore: {},
                            saveAsImage: {}
                        }
                    },
                    dataZoom: [{
                        startValue: '2013-01-01'
                    }, {
                        type: 'inside'
                    }],
                    visualMap: {
                        top: 50,
                        right: 10,
                        pieces: [{
                            gt: 0,
                            lte: 50,
                            color: '#93CE07'
                        }, {
                            gt: 50,
                            lte: 100,
                            color: '#FBDB0F'
                        }, {
                            gt: 100,
                            lte: 150,
                            color: '#FC7D02'
                        }, {
                            gt: 150,
                            lte: 200,
                            color: '#FD0100'
                        }, {
                            gt: 200,
                            lte: 300,
                            color: '#AA069F'
                        }, {
                            gt: 300,
                            color: '#AC3B2A'
                        }],
                        outOfRange: {
                            color: '#999'
                        }
                    },
                    series: [{
                        name: province+' AQI',
                        type: 'line',
                        data: DataY,
                        symbol: 'circle',
                        markLine: {
                            silent: true,
                            lineStyle: {
                                color: '#333'
                            },
                            data: [{
                                yAxis: 50
                            }, {
                                yAxis: 100
                            }, {
                                yAxis: 150
                            }, {
                                yAxis: 200
                            }, {
                                yAxis: 300
                            }]
                        }
                    },
                    {
                        name: 'IAQI_SO2',
                        type: 'line',
                        data: DataSO2,
                        symbol: 'triangle'
                    },
                    {
                        name: 'IAQI_NO2',
                        type: 'line',
                        data: DataNO2,
                        symbol: 'rect'
                    },
                    {
                        name: 'IAQI_PM25',
                        type: 'line',
                        data: DataPM25,
                        symbol: 'roundRect'
                    },
                    {
                        name: 'IAQI_PM10',
                        type: 'line',
                        data: DataPM10,
                        symbol: 'diamond'
                    }]
                });
            });

            if (option && typeof option === 'object') {
                myChart.setOption(option);
            }
        }
    </script>
</body>

</html>